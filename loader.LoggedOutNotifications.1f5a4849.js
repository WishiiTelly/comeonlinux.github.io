"use strict";(self.webpackChunk_twitter_responsive_web=self.webpackChunk_twitter_responsive_web||[]).push([["loader.LoggedOutNotifications"],{5780:(e,t,o)=>{o.r(t),o.d(t,{PromptStatus:()=>l,SET_PROMPT_STATUS:()=>u,default:()=>g,fetchLoggedOutNotificationsDataTypes:()=>m,loadLoggedOutNotificationData:()=>w,pushSubscribeLoggedOut:()=>L,selectArkosePromptStatus:()=>N,selectBrowserPromptStatus:()=>_,selectFetchStatus:()=>b,selectInAppPromptStatus:()=>O,selectIsEligibleForPushPrompt:()=>k,selectLastSeenTimeStamp:()=>A,selectPushNotificationsPromptIsSeen:()=>h,setLastSeenTimeStamp:()=>d,setPromptStatus:()=>P,updatePromptStatus:()=>U,verifyArkoseTokenAndSavePushToken:()=>v,verifyArkoseTokenAndSavePushTokenActionTypes:()=>T});o(71372);var s=o(66136),r=o(59975),n=o(26853),i=o(53392),a=o(23803),c=o(67935);o(6886),o(14121),o(60523);const p="loggedOutNotifications",S="rweb.loggedOutNotifications",u="rweb/loggedOutNotifications/SET_PROMPT_STATUS",E="rweb/loggedOutNotifications/SET_LAST_SEEN_TIMESTAMP",l=Object.freeze({DISMISSED:"dismissed",APPROVED:"approved",NOT_SEEN:"not_seen",SEEN:"seen"}),m=Object.freeze({REQUEST:"rweb/loggedOutNotifications/FETCH_REQUEST",SUCCESS:"rweb/loggedOutNotifications/FETCH_SUCCESS",FAILURE:"rweb/loggedOutNotifications/FETCH_FAILURE"}),T=Object.freeze({REQUEST:"rweb/loggedOutNotifications/SAVE_PUSH_TOKEN_REQUEST",SUCCESS:"rweb/loggedOutNotifications/SAVE_PUSH_TOKEN_SUCCESS",FAILURE:"rweb/loggedOutNotifications/SAVE_PUSH_TOKEN_FAILURE"}),P=(e,t)=>({type:u,payload:{promptType:e,promptStatus:t}}),d=()=>({type:E}),f={inAppPrompt:l.NOT_SEEN,browserPrompt:l.NOT_SEEN,arkosePrompt:l.NOT_SEEN,fetchStatus:a.ZP.NONE};function g(e=f,t){switch(t.type){case m.REQUEST:return{...e,fetchStatus:a.ZP.LOADING};case m.FAILURE:return{...e,fetchStatus:a.ZP.FAILED};case m.SUCCESS:return{...e,...t.payload,fetchStatus:a.ZP.LOADED};case u:if(t.payload)return{...e,[t.payload.promptType]:t.payload.promptStatus};break;case E:return{...e,lastSeenTimestamp:Date.now()};default:return e}return e}const y=e=>({type:m.SUCCESS,payload:e}),O=e=>e[p].inAppPrompt,_=e=>e[p].browserPrompt,N=e=>e[p].arkosePrompt,A=e=>e[p].lastSeenTimestamp,b=e=>e[p].fetchStatus,h=e=>O(e)!==l.NOT_SEEN,k=e=>!h(e),w=()=>(e,t,{devicePersistence:o})=>b(t())===a.ZP.LOADED?Promise.resolve():(e({type:m.REQUEST}),o.get(S).then((t=>null!=t&&t.lastSeenTimestamp&&function(e,t){if(t!==l.APPROVED&&"denied"!==r.qO())return Date.now()-e>6048e5;return!1}(t.lastSeenTimestamp,t.browserPrompt)?e(y(f)):e(y(t)))).catch((()=>e({type:m.FAILURE})))),U=(e,t)=>(o,s,{devicePersistence:r})=>{const n={...s()[p],[e]:t};return r.set(S,n).then((()=>{"inAppPrompt"===e&&t===l.SEEN&&o(d()),o(P(e,t))}))},L=()=>(e,t,{api:o,featureSwitches:s,scribe:n})=>{const i="default"===r.qO(),a={page:"app",section:"permissions",component:"lo_notifications"},c=e=>{i&&n.log({...a,action:e})};return c("impression"),r.pI(!0).then((t=>(c("permissions_granted"),e(U("browserPrompt",l.APPROVED)),Promise.resolve(!0))),(t=>"denied"===r.qO()?(c("permissions_denied"),e(U("browserPrompt",l.DISMISSED)),Promise.resolve(!1)):(c("permissions_error"),e(U("browserPrompt",l.SEEN)),Promise.resolve(!1))))},v=e=>(t,o,{api:n})=>{const{accessToken:a,publicKey:p}=function(e){var t;const o=null==(t=new URL(e,"https://twitter.com").searchParams.get("access_token"))?void 0:t.split("|");if(!o)return{};const s=(o.filter((e=>e.match("pk=")))[0]||"").slice("pk=".length),r=o.filter((e=>e.match("r=")))[0]||"";return{accessToken:r?`${o[0]}|${r}`:o[0],publicKey:s}}(e);if(!a||!p)return Promise.reject(new Error("loggedOutNotifications#verifyArkoseTokenAndSavePushToken: unable to decode arkose link"));return r.pI(!1).then((e=>{const S=o(),u=(0,c.VT)(S),E=(0,s.o)(u),{os_version:l=""}=r.lX(),{encryptionKey1:m,encryptionKey2:P,pushFcmToken:d}=function(e){const t={pushFcmToken:e.endpoint,encryptionKey1:"",encryptionKey2:""};return e.keys&&(t.encryptionKey1=e.keys.p256dh,t.encryptionKey2=e.keys.auth),t}(e),f={locale:E,accessToken:a,publicKey:p,language:u,osVersion:l,encryptionKey1:m,encryptionKey2:P,pushFcmToken:d};return i.AB(t,{params:f,request:n.LoggedOutNotifications.enableLoggedOutWebNotifications})({actionTypes:T,context:"SAVE_PUSH_TOKEN",meta:f})}),(e=>Promise.reject(e)))};n.Z.register({[p]:g})}}]);
//# sourceMappingURL=https://ton.local.twitter.com/responsive-web-internal/sourcemaps/client-web/loader.LoggedOutNotifications.1f5a4849.js.map